#!/usr/bin/env python

import sys, os, pwd
import platform
import re

user = pwd.getpwuid(os.getuid())[0]
if user != 'root':
    print("login as root and run again")
    sys.exit()

s = open('/etc/os-release', 'r').read()
fedora_vers = re.compile('REDHAT_BUGZILLA_PRODUCT_VERSION=(\d+)').search(s).group(1)
print(">>>> fedora version:", fedora_vers)

py_vers = platform.python_version().split(".")
print(">>>> python version: %s.%s" % (py_vers[0], py_vers[1]))

#os.system('dnf -y install emacs')

# download data from github
def download():
    print(">>>> downloading update_vm data ...", flush=True)
    os.system('rm -rf tmp; mkdir tmp; cd tmp; git clone http://github.com/yliow/update-vm-data')

# latex
def latex():
    print(">>>> installing latex packages ...", flush=True)
    os.system('rm -rf /usr/share/texlive/texmf-local/tex/latex/yliowtest')
    os.system('mkdir /usr/share/texlive/texmf-local/tex/latex/yliowtest')
    os.system('cd tmp/update-vm-data/; cp -r latex/*  /usr/share/texlive/texmf-local/tex/latex/yliowtest/')
    os.system('chmod a+rwx /usr/share/texlive/texmf-local/tex/latex/yliowtest')
    os.system('texhash')

# python
def python():
    print(">>>> installing python packages ...", flush=True)
    for p in ['/usr/lib/python*.*', '/usr/lib64/python*.*']:
        os.system('cd tmp/update-vm-data/; cp -r python/* %s/site-packages/' % p)
        os.system('chmod a+rwx %s/site-packages/' % p)

# alex
# WARNING: Do not delete ~/.alex in case there's a ~/.alex/alex config file
# WARNING: alex is installed for all users (except root)
def alex():
    print(">>>> installing alex ...", flush=True)
    os.system('ls /home/ > home.txt')
    f = open('home.txt', 'r')
    s = f.read()
    f.close()
    s = [_.strip() for _ in s.split('\n') if _.strip() != '']
    users = [_ for _ in s if _ != 'root']
    print(">>>> users found ... ", users)

    f = open('tmp/update-vm-data/alex/import_alex.py', 'w')
    f.write("import alex"); f.close()

    for user in users:
        print(">>>> install alex for %s" % user)
        os.system('mkdir /home/%s/.alex' % user)
        os.system('chmod a+rwx /home/%s/.alex' % user)
        os.system('cd tmp/update-vm-data/alex; cp alexrunner.py /home/%s/.alex/' % user)
        os.system('cd tmp/update-vm-data/alex; python3 import_alex.py; rm -rf import_alex.py')
        os.system('cd tmp/update-vm-data/alex; cp __pycache__/*.pyc /home/%s/.alex/alex.pyc' % user)
        os.system('chmod a+rwx /home/%s/.alex/*' % user)
        # update .bashrc
        os.system('cp /home/%s/.bashrc /home/%s/.bashrc.backup' % (user, user))
        f = open('/home/%s/.bashrc' % user, 'r')
        s = f.read()
        f.close()
        t = "alias alex='python /home/%s/.alex/alexrunner.py'" % user
        if t not in s:
            s += '\n' + t + '\n'
            f = open('/home/%s/.bashrc' % user, 'w'); f.write(s); f.close()

download()
latex()
python()
alex()
#os.system('rm -rf tmp')

